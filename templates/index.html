<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GenAI Medical Assistant</title>
<style>
  body { font-family: Arial, sans-serif; background:#f5f7fb; margin:0; padding:24px; display:flex; justify-content:center; }
  .card { width:100%; max-width:820px; background:white; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); padding:18px; }
  h1 { margin:0 0 10px 0; font-size:20px; color:#1f2937; }
  #chat { height:420px; overflow:auto; border-radius:8px; border:1px solid #e6e9ee; padding:12px; background:#fbfdff; }
  .bubble { max-width:78%; padding:10px 12px; margin:8px 0; border-radius:10px; word-break:break-word; }
  .bubble.user { margin-left:auto; background:#0ea5a4; color:white; }
  .bubble.bot { margin-right:auto; background:#f1f5f9; color:#0f172a; }
  .controls { display:flex; gap:8px; margin-top:12px; align-items:center; }
  input[type="text"] { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; }
  input[type="file"] { padding:6px; }
  button { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; background:#2563eb; color:white; }
  button.secondary { background:#ef4444; }
  .note { font-size:13px; color:#6b7280; margin-top:8px; }
  .loading { font-style:italic; color:#374151; margin-top:6px; }
</style>
</head>
<body>
  <div class="card">
    <h1>ðŸ©º GenAI Medical Assistant</h1>

    <div id="chat"></div>

    <form id="form" class="controls">
      <input id="query" type="text" placeholder="Ask about the image or disease..." required />
      <input id="file" type="file" accept="image/*" />
      <button id="send">Send</button>
      <button id="reset" type="button" class="secondary">Reset</button>
    </form>

    <div class="note">First request: include an image. Follow-ups: only text required.</div>
    <div id="loading" class="loading" style="display:none">Processing... please wait.</div>
  </div>

<script>
const chat = document.getElementById("chat");
const form = document.getElementById("form");
const fileInput = document.getElementById("file");
const queryInput = document.getElementById("query");
const sendBtn = document.getElementById("send");
const resetBtn = document.getElementById("reset");
const loading = document.getElementById("loading");

let firstRequest = true;

function addBubble(text, who) {
  const d = document.createElement("div");
  d.className = "bubble " + (who === "user" ? "user" : "bot");
  d.textContent = text;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

function resizeFileToBlob(file, maxWidth = 1024, quality = 0.78) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = () => {
      const img = new Image();
      img.onerror = reject;
      img.onload = () => {
        const scale = Math.min(1, maxWidth / img.width);
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob((blob) => {
          if (!blob) {
            reject(new Error("Canvas toBlob failed"));
            return;
          }
          resolve(blob);
        }, 'image/jpeg', quality);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

async function sendForm(query, file) {
  loading.style.display = "block";
  sendBtn.disabled = true;
  const formData = new FormData();
  formData.append("query", query);

  if (firstRequest && file) {
    // resize client-side and include as file upload
    try {
      const blob = await resizeFileToBlob(file, 1024, 0.78);
      formData.append("image_file", blob, "upload.jpg");
    } catch (err) {
      addBubble("Image processing failed on client: " + err.message, "bot");
      loading.style.display = "none";
      sendBtn.disabled = false;
      return;
    }
  }

  try {
    const res = await fetch("/analyze", { method: "POST", body: formData });
    if (!res.ok) {
      const txt = await res.text();
      addBubble("Error: " + txt, "bot");
      return;
    }
    const data = await res.json();
    addBubble(data.answer || "No answer.", "bot");
    if (firstRequest && file) firstRequest = false;
  } catch (err) {
    addBubble("Network error: " + err.message, "bot");
  } finally {
    loading.style.display = "none";
    sendBtn.disabled = false;
  }
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const q = queryInput.value.trim();
  if (!q) return;
  addBubble(q, "user");

  const f = fileInput.files.length ? fileInput.files[0] : null;
  if (firstRequest && !f) {
    addBubble("Please upload an image for the first request.", "bot");
    return;
  }

  await sendForm(q, f);
  queryInput.value = "";
});

resetBtn.addEventListener("click", async () => {
  try {
    await fetch("/reset", { method: "POST" });
    chat.innerHTML = "";
    firstRequest = true;
    addBubble("Conversation reset. Upload a new image to start again.", "bot");
    fileInput.value = "";
    queryInput.value = "";
  } catch (err) {
    addBubble("Reset failed: " + err.message, "bot");
  }
});

// welcome
addBubble("Welcome! Upload an image and ask a question to analyze.", "bot");
</script>
</body>
</html>
