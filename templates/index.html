<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GenAI Medical Assistant — Polished UI</title>

<style>
  :root{
    --bg-1: #0f172a;
    --bg-2: #071027;
    --card: rgba(255,255,255,0.06);
    --glass: rgba(255,255,255,0.06);
    --accent-1: #7c3aed; /* purple */
    --accent-2: #06b6d4; /* teal */
    --accent-3: #f97316; /* orange */
    --muted: #94a3b8;
    --soft: rgba(255,255,255,0.06);
    --glass-border: rgba(255,255,255,0.08);
  }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; color:#e6eef8; background:linear-gradient(135deg,var(--bg-1) 0%, #08203a 60%, #04243d 100%); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}

  /* page center & 3d perspective */
  .page {
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:36px;
    perspective:1400px;
  }

  /* main card (3D tilt) */
  .card {
    width:100%;
    max-width:1060px;
    border-radius:18px;
    padding:18px;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    box-shadow:
      0 20px 50px rgba(2,6,23,0.6),
      inset 0 1px 0 rgba(255,255,255,0.02);
    transform-style:preserve-3d;
    transition: transform 0.12s ease-out;
    border: 1px solid var(--glass-border);
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:20px;
    overflow:hidden;
  }

  /* left sidebar */
  .left {
    padding:20px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-right:1px solid rgba(255,255,255,0.02);
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .brand {
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo {
    width:56px;height:56px;border-radius:12px;
    background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
    display:flex;align-items:center;justify-content:center;
    box-shadow: 0 6px 18px rgba(124,58,237,0.18);
    transform: translateZ(40px);
  }
  .logo svg{width:34px;height:34px;filter:drop-shadow(0 3px 8px rgba(0,0,0,0.25))}
  .title {font-weight:700; font-size:16px; color:white; letter-spacing: -0.2px;}
  .subtitle {font-size:12px; color:var(--muted); margin-top:3px;}

  /* instructions */
  .muted {color:var(--muted); font-size:13px; margin-top:6px}

  /* preview */
  .preview {
    margin-top:6px;
    width:100%; height:200px;
    border-radius:12px; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    border:1px dashed rgba(255,255,255,0.03);
  }
  .preview img{max-width:100%; max-height:100%; object-fit:contain}

  /* left controls */
  .controls{display:flex; gap:8px; align-items:center; margin-top:10px}
  .file-btn {
    padding:10px 12px; border-radius:10px; cursor:pointer;
    background: linear-gradient(90deg,var(--accent-1),var(--accent-2));
    color:white; font-weight:600; border:none; box-shadow: 0 8px 20px rgba(2,6,23,0.5);
  }
  .reset-btn {
    padding:10px 12px; border-radius:10px; cursor:pointer;
    background: transparent; color:var(--accent-3); border:1px solid rgba(249,115,22,0.12); font-weight:600;
  }
  .small {font-size:13px;color:var(--muted)}

  /* right content area */
  .right {
    padding:22px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .chat-header {
    display:flex; align-items:center; justify-content:space-between;
  }
  .chat-title {
    display:flex; gap:12px; align-items:center;
  }
  .model-pill {
    padding:8px 10px; border-radius:999px; font-size:13px; color:#041024; font-weight:700;
    background: linear-gradient(90deg,#ffecb3, #ffd8a8);
    box-shadow: 0 6px 20px rgba(249,115,22,0.12);
  }

  /* chat window */
  #chat {
    flex:1;
    border-radius:12px;
    padding:14px;
    overflow:auto;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
    border:1px solid rgba(255,255,255,0.02);
  }

  .msg { display:flex; gap:10px; margin-bottom:12px; align-items:flex-end; opacity:0; transform:translateY(8px); animation: enter 320ms ease forwards; }
  @keyframes enter { to { opacity:1; transform:none } }

  .avatar {
    min-width:40px; width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center;
    font-weight:700; color:#08122b;
  }
  .avatar.user { background:linear-gradient(135deg,var(--accent-2),var(--accent-1)); color:white; margin-left:auto; order:2 }
  .avatar.bot { background:#e6eef8; color:#052033; order:0 }

  .bubble {
    padding:12px 14px; border-radius:12px; max-width:72%; line-height:1.35; font-size:14px;
    box-shadow: 0 6px 18px rgba(2,6,23,0.45);
  }
  .bubble.bot { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color: #e6eef8; border: 1px solid rgba(255,255,255,0.03); }
  .bubble.user { background: linear-gradient(90deg,var(--accent-2),var(--accent-1)); color:white; margin-left:auto; }

  .meta { font-size:11px; color:var(--muted); margin-top:6px; }

  /* input area */
  .composer {
    display:flex; gap:10px; align-items:center; margin-top:6px;
    padding:12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    border:1px solid rgba(255,255,255,0.02);
  }
  .composer input[type="text"] { flex:1; border:none; background:transparent; color:var(--muted); padding:10px; font-size:15px; outline:none; color:#e6eef8 }
  .composer .send {
    padding:10px 14px; border-radius:10px; background:linear-gradient(90deg,var(--accent-1),var(--accent-2));
    color:white; border:none; cursor:pointer; font-weight:700; transform: translateZ(20px);
  }
  .composer .send:hover { transform: translateY(-3px) scale(1.02) }

  /* send spinner */
  .spinner {
    border: 3px solid rgba(255,255,255,0.08);
    border-top: 3px solid white;
    border-radius:50%;
    width:18px;height:18px; animation: spin 0.9s linear infinite; display:inline-block;
  }
  @keyframes spin { to { transform: rotate(360deg) } }

  /* small screens */
  @media (max-width:920px){
    .card { grid-template-columns: 1fr; padding:14px; }
    .left { order:2; }
    .right { order:1 }
  }
</style>
</head>
<body>
  <div class="page">
    <div class="card" id="card3d" aria-live="polite">
      <!-- LEFT -->
      <div class="left">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <!-- subtle medical icon -->
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="2" width="20" height="20" rx="5" fill="white" opacity="0.08"/>
              <path d="M12 6v12M6 12h12" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <div class="title">GenAI Medical</div>
            <div class="subtitle small">Image-first disease analyzer • AI-assisted guidance</div>
          </div>
        </div>

        <div class="muted">Upload a medical image (X-ray, skin, scan). First request should include the image. Ask follow-ups after initial analysis.</div>

        <div class="preview" id="preview">
          <div class="small" id="preview-placeholder">No image selected</div>
        </div>

        <div class="controls">
          <label class="file-btn" for="fileInput">Upload Image</label>
          <input id="fileInput" type="file" accept="image/*" style="display:none" />
          <button id="resetBtn" class="reset-btn">Reset</button>
        </div>

        <div class="small" style="margin-top:8px">Tip: Large images are resized client-side for faster processing.</div>
      </div>

      <!-- RIGHT -->
      <div class="right">
        <div class="chat-header">
          <div class="chat-title">
            <div style="font-weight:800">Chat & Analysis</div>
            <div class="meta" style="margin-left:8px">Model: <span class="model-pill">Llama-4 Scout</span></div>
          </div>
          <div class="meta">Session: <span id="sessionId">—</span></div>
        </div>

        <div id="chat" role="log" aria-live="polite"></div>

        <div class="composer" role="form" aria-label="Send a message">
          <input type="text" id="queryInput" placeholder="Ask about the image or disease..." autocomplete="off" />
          <button id="sendBtn" class="send">Send</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- 3D tilt effect ---------- */
const card = document.getElementById('card3d');
const perspective = 1000;
card.addEventListener('mousemove', (e) => {
  const rect = card.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  const dx = e.clientX - cx;
  const dy = e.clientY - cy;
  const rx = (-dy / rect.height) * 12; // rotateX
  const ry = (dx / rect.width) * 12;   // rotateY
  card.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) translateZ(0)`;
});
card.addEventListener('mouseleave', () => {
  card.style.transform = 'rotateX(0deg) rotateY(0deg)';
});

/* ---------- Chat / UI logic ---------- */
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const previewPlaceholder = document.getElementById('preview-placeholder');
const resetBtn = document.getElementById('resetBtn');
const chat = document.getElementById('chat');
const sendBtn = document.getElementById('sendBtn');
const queryInput = document.getElementById('queryInput');
const sessionEl = document.getElementById('sessionId');

let firstRequest = true;
let sessionId = null;

// append bubble helper
function appendBubble(text, who='bot') {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
  const avatar = document.createElement('div');
  avatar.className = 'avatar ' + (who === 'user' ? 'user' : 'bot');
  avatar.textContent = (who === 'user') ? 'U' : 'AI';
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (who === 'user' ? 'user' : 'bot');
  bubble.textContent = text;
  const meta = document.createElement('div');
  meta.className = 'meta';
  const now = new Date();
  meta.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  if (who === 'user') {
    wrapper.appendChild(bubble);
    wrapper.appendChild(avatar);
  } else {
    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);
  }
  wrapper.appendChild(meta);
  chat.appendChild(wrapper);
  chat.scrollTop = chat.scrollHeight;
}

/* typing indicator */
function addTyping() {
  const div = document.createElement('div');
  div.className = 'msg bot typing';
  div.id = '__typing';
  const avatar = document.createElement('div'); avatar.className='avatar bot'; avatar.textContent='AI';
  const bubble = document.createElement('div'); bubble.className='bubble bot';
  bubble.innerHTML = '<span class="spinner" style="display:inline-block;margin-right:8px"></span>Analyzing...';
  div.appendChild(avatar); div.appendChild(bubble);
  chat.appendChild(div); chat.scrollTop = chat.scrollHeight;
}
function removeTyping() {
  const t = document.getElementById('__typing');
  if (t) t.remove();
}

/* Preview image when user selects file */
fileInput.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) {
    preview.innerHTML = '<div class="small">No image selected</div>';
    return;
  }
  // show quick preview
  const url = URL.createObjectURL(f);
  preview.innerHTML = '<img src="'+url+'" alt="preview"/>';
});

/* reset conversation */
resetBtn.addEventListener('click', async () => {
  try {
    const r = await fetch('/reset', { method:'POST' });
    appendBubble('Conversation reset. Upload a new image.', 'bot');
    firstRequest = true;
    preview.innerHTML = '<div class="small">No image selected</div>';
    sessionEl.textContent = '—';
  } catch (err) {
    appendBubble('Reset failed: '+err.message, 'bot');
  }
});

/* client-side resize: returns a Blob */
function resizeFileToBlob(file, maxWidth = 1024, quality = 0.78) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = () => {
      const img = new Image();
      img.onerror = reject;
      img.onload = () => {
        const scale = Math.min(1, maxWidth / img.width);
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob((blob) => {
          if (!blob) reject(new Error('Canvas toBlob failed'));
          else resolve(blob);
        }, 'image/jpeg', quality);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

/* send form */
async function sendRequest(query, file) {
  // UI updates
  appendBubble(query, 'user');
  addTyping();
  sendBtn.disabled = true;

  const formData = new FormData();
  formData.append('query', query);

  if (firstRequest && file) {
    try {
      const resized = await resizeFileToBlob(file, 1024, 0.78);
      formData.append('image_file', resized, 'upload.jpg');
    } catch (err) {
      removeTyping(); appendBubble('Image processing failed: ' + err.message, 'bot'); sendBtn.disabled=false; return;
    }
  }

  try {
    const res = await fetch('/analyze', { method:'POST', body: formData });
    const text = await res.text();
    if (!res.ok) {
      removeTyping();
      appendBubble('Server Error: ' + text, 'bot');
      sendBtn.disabled = false;
      return;
    }
    const data = JSON.parse(text);
    removeTyping();
    appendBubble(data.answer || 'No answer returned', 'bot');

    // store session id if present
    if (data.session_id) {
      sessionId = data.session_id;
      sessionEl.textContent = sessionId.slice(0,8) + '…';
    } else if (!sessionId) {
      // try reading cookie (best-effort)
      const c = document.cookie.match(/session_id=([^;]+)/);
      if (c) { sessionId = c[1]; sessionEl.textContent = sessionId.slice(0,8)+'…'; }
    }

    if (firstRequest && file) firstRequest = false;
  } catch (err) {
    removeTyping();
    appendBubble('Network error: ' + err.message, 'bot');
  } finally {
    sendBtn.disabled = false;
  }
}

/* form handling */
document.getElementById('sendBtn').addEventListener('click', (e) => {
  e.preventDefault();
  const q = queryInput.value.trim();
  if (!q) return;
  const f = fileInput.files.length ? fileInput.files[0] : null;
  if (firstRequest && !f) { appendBubble('Please upload an image for the first request', 'bot'); return; }
  sendRequest(q, f);
  queryInput.value = '';
});
queryInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});

/* welcome message */
appendBubble('Welcome! Upload an image and ask a question to begin.', 'bot');

</script>
</body>
</html>
